<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Catalogue Visualizer</title>
    <link rel="stylesheet" href="/static/css/style.css?v=5">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="/static/js/config.js"></script>
    <script src="/static/js/viewer.js?v=7" defer></script>
    <script src="/static/js/charts.js?v=7" defer></script>
</head>

<body>
    <div class="app-container">
        <header>
            <h1><span class="logo-icon">üåå</span> Halo Visualizer</h1>
            <div class="upload-section">
                <input type="file" id="fileInput" accept=".hdf5,.h5,.csv">
                <label for="fileInput" class="upload-btn">Upload Catalogue</label>
                <span id="fileName">No file chosen</span>
            </div>
        </header>

        <main>
            <aside class="sidebar">
                <details class="panel" open>
                    <summary>
                        <h2>Controls</h2>
                    </summary>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Halo Size</label>
                            <input type="range" id="pointSize" min="0.1" max="10" step="0.1" value="3">
                        </div>
                        <div class="control-group">
                            <label>Opacity</label>
                            <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.8">
                        </div>
                    </div>
                </details>

                <details class="panel" open>
                    <summary>
                        <h2>Filters & Slicing</h2>
                    </summary>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Filter by Mass (log10 M<sub>‚òâ</sub>)</label>
                            <div class="range-inputs">
                                <input type="number" id="minMass" placeholder="Min">
                                <input type="number" id="maxMass" placeholder="Max">
                            </div>
                        </div>

                        <div class="control-group">
                            <label>Spatial Slicing (X) [Mpc]</label>
                            <div class="range-inputs">
                                <input type="number" id="xMin" placeholder="Min X">
                                <input type="number" id="xMax" placeholder="Max X">
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Spatial Slicing (Y) [Mpc]</label>
                            <div class="range-inputs">
                                <input type="number" id="yMin" placeholder="Min Y">
                                <input type="number" id="yMax" placeholder="Max Y">
                            </div>
                        </div>
                        <div class="control-group">
                            <label>Spatial Slicing (Z) [Mpc]</label>
                            <div class="range-inputs">
                                <input type="number" id="zMin" placeholder="Min Z">
                                <input type="number" id="zMax" placeholder="Max Z">
                            </div>
                        </div>

                        <button id="applyFilter">Apply Filters & Slice</button>
                    </div>
                </details>



                <details class="panel" id="hierarchy-panel">
                    <summary>
                        <h2>Subhalo Hierarchy</h2>
                    </summary>
                    <div class="control-content">
                        <div class="placeholder-text">Hierarchy settings coming soon. View the tree in the "Hierarchy"
                            tab.</div>
                    </div>
                </details>

                <details class="panel">
                    <summary>
                        <h2>Coordinate System</h2>
                    </summary>
                    <div class="control-content">
                        <div class="control-group">
                            <label>System</label>
                            <select id="coordSystem"
                                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border);">
                                <option value="cartesian">Cartesian (X, Y, Z)</option>
                                <option value="cylindrical">Cylindrical (œÅ, œÜ, Z)</option>
                                <option value="spherical">Spherical (r, Œ∏, œÜ)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Center Point</label>
                            <div class="range-inputs">
                                <input type="number" placeholder="0">
                                <input type="number" placeholder="0">
                                <input type="number" placeholder="0">
                            </div>
                        </div>
                    </div>
                </details>

                <details class="panel">
                    <summary>
                        <h2>Other Settings</h2>
                    </summary>
                    <div class="control-content">
                        <div class="control-group">
                            <label>Color Map</label>
                            <select
                                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border);">
                                <option>Viridis</option>
                                <option>Plasma</option>
                                <option>Inferno</option>
                                <option>Magma</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Background</label>
                            <select
                                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border);">
                                <option>Black</option>
                                <option>White</option>
                                <option>Starfield</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Performance Mode</label>
                            <input type="checkbox">
                        </div>
                    </div>
                </details>
            </aside>

            <div class="content-area">
                <div class="tab-bar">
                    <button class="tab-btn active" data-tab="viewer">3D Viewer</button>
                    <button class="tab-btn" data-tab="dashboard">Analysis Dashboard</button>
                    <button class="tab-btn" data-tab="hierarchy">Hierarchy</button>
                </div>

                <div class="tab-content active" id="tab-viewer">
                    <div id="viewer3d" class="viewer-container">
                        <div id="haloInfoOverlay"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 10px; border-radius: 5px; font-family: monospace; display: none;">
                        </div>
                        <!-- Three.js Canvas will be here -->
                        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                            <div class="spinner"></div>
                            <p>Processing Data...</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-dashboard">
                    <section class="dashboard">
                        <div class="chart-card">
                            <h3>Halo Mass Function</h3>
                            <div id="hmfChart"></div>
                        </div>
                        <div class="chart-card">
                            <h3>Cumulative HMF</h3>
                            <div id="cumulativeHmfChart"></div>
                        </div>
                        <div class="chart-card">
                            <h3>Radius Histogram</h3>
                            <div id="radiusChart"></div>
                        </div>
                        <div class="chart-card">
                            <h3>Mass vs Radius</h3>
                            <div id="scatterChart"></div>
                        </div>
                    </section>
                </div>

                <div class="tab-content" id="tab-hierarchy">
                    <div id="subhalo-hierarchy" class="hierarchy-tree">
                        <div class="placeholder-text">Select a file with hierarchy data to view structure.</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Schema Mapping Modal -->
        <div id="schemaModal" class="modal">
            <div class="modal-content">
                <h2>Map H5 Schema</h2>
                <p>We detected the following fields. Please confirm or correct them.</p>

                <div class="schema-form">
                    <div class="form-group">
                        <label>Halo ID (Required)</label>
                        <select id="mapId"></select>
                    </div>
                    <div class="form-group">
                        <label>Mass (Required)</label>
                        <select id="mapMass"></select>
                    </div>
                    <div class="form-group">
                        <label>Position (Required, Nx3)</label>
                        <select id="mapPos"></select>
                    </div>
                    <div class="form-group">
                        <label>Radius (Optional)</label>
                        <select id="mapRadius">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Parent ID (Optional)</label>
                        <select id="mapParent">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="confirmSchema" class="btn-primary">Confirm & Ingest</button>
                    <button id="cancelSchema" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

</body>

</html>